import { 
  createBridgeKit, 
  isKitError, 
  isRetryableError 
} from "@circle-fin/bridge-kit";
import { createViemAdapterFromPrivateKey } from "@circle-fin/adapter-viem-v2";
import { createSolanaAdapterFromPrivateKey } from "@circle-fin/adapter-solana-kit";
import { createCCTPProvider } from "@circle-fin/provider-cctp-v2";

/**
 * ============================================================
 * SUPER APP HUB - V5.5 FULL EXECUTABLE
 * ============================================================
 */

// 1. CONFIGURA√á√ïES (Substitui pelos teus dados ou usa .env)
const PRIVATE_KEY = "0x..." ; // Tua chave privada EVM (Arc/Eth/Monad)
const SOLANA_PRIVATE_KEY = "..."; // Tua chave Solana (Base58)
const USER_ADDRESS = "..."; // Teu endere√ßo p√∫blico

async function main() {
  console.log("üöÄ A iniciar Super App Hub v5.5...");

  try {
    // 2. INICIALIZA√á√ÉO DOS ADAPTADORES COM SIGNERS (Essencial para assinar txs)
    const viemAdapter = createViemAdapterFromPrivateKey({
      privateKey: PRIVATE_KEY as `0x${string}`,
    });

    const solanaAdapter = createSolanaAdapterFromPrivateKey({
      privateKey: SOLANA_PRIVATE_KEY,
      computeUnitLimit: 350000, // Upgrade v1.3.1 para estabilidade CCTP
    });

    const kit = createBridgeKit({
      adapters: [viemAdapter, solanaAdapter],
      providers: [createCCTPProvider()] // Motor CCTP com Auto-Recovery v1.5.0
    });

    // 3. CONSULTA DE SALDOS (Multi-chain sem pop-ups)
    console.log("\nüí∞ Verificando saldos em background...");
    const chains = ['ethereum-mainnet', 'arc-testnet', 'solana-mainnet'];
    
    for (const chain of chains) {
      try {
        const balance = await kit.adapter(chain).native.balanceOf(USER_ADDRESS);
        console.log(`   - ${chain.toUpperCase()}: ${balance.formatted} ${balance.symbol}`);
      } catch (e) {
        console.log(`   - ${chain.toUpperCase()}: Erro ao ler saldo (verifica a rede)`);
      }
    }

    // 4. PAR√ÇMETROS DA TRANSFER√äNCIA (Exemplo: ETH -> ARC)
    const bridgeParams = {
      sourceChain: 'ethereum-mainnet',
      destinationChain: 'arc-testnet', // Onde o USDC √© g√°s nativo
      token: 'USDC',
      amount: '10.0',
      sourceAddress: USER_ADDRESS,
      destinationAddress: USER_ADDRESS
    };

    // 5. ESTIMATIVA E VALIDA√á√ÉO PRE-FLIGHT
    console.log("\nüõ†Ô∏è Analisando rota e validando taxas...");
    const estimate = await kit.estimate(bridgeParams);

    if (!estimate.gasEstimation.hasEnoughNativeToken) {
      throw new Error(`G√°s insuficiente. Precisas de ${estimate.gasEstimation.amount} na rede de origem.`);
    }

    // 6. EXECU√á√ÉO DA PONTE
    console.log(`‚úÖ Tudo OK. Iniciando Bridge para ${bridgeParams.destinationChain}...`);
    const transfer = await kit.bridge(bridgeParams);

    // 7. MONITORIZA√á√ÉO COM AUTO-RECOVERY (v1.5.0)
    const result = await transfer.waitForSuccess({
      onStatusUpdate: (step) => {
        console.log(`[${new Date().toLocaleTimeString()}] ${step.type}: ${step.status}`);
        
        // Novo utilit√°rio v1.5.0: Detec√ß√£o de expira√ß√£o autom√°tica
        if (step.status === 'attestation_expired') {
          console.warn("‚ö†Ô∏è Atesta√ß√£o expirou no CCTP. O Kit est√° a re-atestar a transa√ß√£o...");
        }
      }
    });

    console.log("\n==========================================");
    console.log("üéâ TRANSFER√äNCIA CONCLU√çDA COM SUCESSO!");
    console.log(`üîó Hash: ${result.transactionHash}`);
    console.log("==========================================\n");

  } catch (error) {
    // 8. GEST√ÉO DE ERROS INTELIGENTE
    if (isKitError(error)) {
      console.error(`‚ùå Erro Circle [${error.code}]: ${error.message}`);
      if (isRetryableError(error)) console.log("üîÑ Dica: O erro parece tempor√°rio, tenta novamente.");
    } else {
      console.error("‚ùå Erro de Execu√ß√£o:", error);
    }
  }
}

main();
